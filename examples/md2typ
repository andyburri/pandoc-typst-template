#!/bin/bash
# md2typ - Convert Markdown to Typst using Pandoc

SCRIPT_DIR=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )
SHARE_DIR="$SCRIPT_DIR/../cmd"

# Exit if any command fails
set -e

# Check for input file
if [ $# -lt 1 ]; then
    echo "Usage: $(basename "$0") <input.md> [output.typ] [--pandoc-options...]" >&2
    exit 1
fi

# Parse arguments: find output file (ends with .typ) and collect inputs/options
output=""
inputs=()
extra_args=()

for arg in "$@"; do
    if [[ "$arg" == *.typ ]]; then
        output="$arg"
    elif [[ "$arg" == --* ]]; then
        # Pandoc option
        extra_args+=("$arg")
    else
        # Input file
        inputs+=("$arg")
    fi
done

# Check that we have at least one input file
if [ ${#inputs[@]} -eq 0 ]; then
    echo "Error: No input files specified." >&2
    exit 1
fi

# Use first input for directory resolution (for output path)
input="${inputs[0]}"

# Ensure all input files exist
for infile in "${inputs[@]}"; do
    if [ ! -f "$infile" ]; then
        echo "Error: File '$infile' not found." >&2
        exit 1
    fi
done

# Resolve input directory (use first input for directory)
input_dir="$(cd "$(dirname "$input")" && pwd)"

# If no output provided, use first input file name with .typ extension
if [ -z "$output" ]; then
    input_file="$(basename "$input")"
    base="${input_file%.*}"
    output="${base}.typ"
fi

# Resolve all input files to absolute paths
input_files=()
for infile in "${inputs[@]}"; do
    # If it's already absolute, use as-is; otherwise resolve relative to current dir
    if [[ "$infile" == /* ]]; then
        input_files+=("$infile")
    else
        input_files+=("$(cd "$(dirname "$infile")" && pwd)/$(basename "$infile")")
    fi
done

# Change to input directory (for relative output paths)
cd "$input_dir"

# Run pandoc to convert
if [ ${#inputs[@]} -eq 1 ]; then
    echo "Converting '${inputs[0]}' → '$output'..."
else
    echo "Converting ${#inputs[@]} files → '$output'..."
fi
pandoc "${input_files[@]}" -o "$output" \
 --template="$SHARE_DIR/template/bergfink.typst" \
 -L "$SHARE_DIR/filters/include-files.lua" \
 -L "$SHARE_DIR/filters/diagram.lua" \
 -L "$SHARE_DIR/filters/typst-filters.lua" \
 "${extra_args[@]}"

echo "✅ Done: $input_dir/$output"

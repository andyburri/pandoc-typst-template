#!/bin/bash
# md2typ - Convert Markdown to typst using Pandoc

SCRIPT_DIR=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )
SHARE_DIR="$SCRIPT_DIR/../cmd"

# Exit if any command fails
set -e

# Check for input file
if [ $# -lt 1 ]; then
    echo "Usage: $(basename "$0") <input.md> [output.typ] [--pandoc-options...]" >&2
    exit 1
fi

input="$1"
shift # remove first argument (input file)

output=""
extra_args=()

# Check if the next argument is an output file (ends with .typ)
if [[ "$1" == *.typ ]]; then
    output="$1"
    shift # remove output argument
fi

# The rest are extra pandoc arguments
extra_args=("$@")

# Ensure input file exists
if [ ! -f "$input" ]; then
    echo "Error: File '$input' not found." >&2
    exit 1
fi

# Resolve input directory and filename
input_dir="$(cd "$(dirname "$input")" && pwd)"
input_file="$(basename "$input")"

# If no output provided, replace .md with .typ
if [ -z "$output" ]; then
    base="${input_file%.*}"
    output="${base}.typ"
fi

# Change to input directory
input_dir="$(cd "$(dirname "$input")" && pwd)"
cd "$input_dir"

# Run pandoc to convert
echo "Converting '$input' → '$output'..."
pandoc "$input_file" -o "$output" --pdf-engine=typst \
 --template=$SHARE_DIR/template/bergfink.typst \
 -L $SHARE_DIR/filters/include-files.lua \
 -L $SHARE_DIR/filters/diagram.lua \
 -L $SHARE_DIR/filters/typst-filters.lua \
 "${extra_args[@]}"

echo "✅ Done: $output"
